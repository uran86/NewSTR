<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Checkout ‚Äî InexPro</title>
  <script src="https://js.stripe.com/v3/"></script>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet"/>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg: #0e0f13;
      --card: #18191f;
      --border: #2a2b33;
      --input-bg: #111217;
      --accent: #5b7fff;
      --accent-hover: #4a6ef0;
      --text: #f0f1f5;
      --muted: #6b6f7e;
      --label: #7a7f91;
      --info-bg: #1a1f35;
      --info-border: #2a3560;
      --info-text: #8ba4f8;
      --success: #34d399;
      --error: #f87171;
    }

    body {
      font-family: 'Inter', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 3rem 1rem 5rem;
    }

    /* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
    .header {
      text-align: center;
      margin-bottom: 2.2rem;
    }

    .pill {
      display: inline-block;
      border: 1.5px solid #3a3f55;
      border-radius: 100px;
      padding: 0.35rem 1.1rem;
      font-size: 0.7rem;
      font-weight: 600;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: #8b92b0;
      margin-bottom: 1.2rem;
    }

    h1 {
      font-family: 'Playfair Display', serif;
      font-size: 2.8rem;
      font-weight: 700;
      letter-spacing: -0.01em;
      line-height: 1.1;
      margin-bottom: 0.75rem;
    }

    .subtitle {
      color: var(--muted);
      font-size: 0.95rem;
      font-weight: 300;
    }

    /* ‚îÄ‚îÄ Card ‚îÄ‚îÄ */
    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 2.2rem 2rem;
      width: 100%;
      max-width: 600px;
      margin-bottom: 0.8rem;
    }

    /* ‚îÄ‚îÄ Section labels ‚îÄ‚îÄ */
    .section-label {
      font-size: 0.68rem;
      font-weight: 600;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: var(--label);
      margin-bottom: 1.1rem;
    }

    .divider {
      border: none;
      border-top: 1px solid var(--border);
      margin: 1.8rem 0;
    }

    /* ‚îÄ‚îÄ Form fields ‚îÄ‚îÄ */
    .form-group { margin-bottom: 1.1rem; }

    .field-label {
      font-size: 0.68rem;
      font-weight: 600;
      letter-spacing: 0.09em;
      text-transform: uppercase;
      color: var(--label);
      margin-bottom: 0.5rem;
      display: block;
    }

    input, select {
      width: 100%;
      background: var(--input-bg);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 1rem 1.1rem;
      color: var(--text);
      font-family: 'Inter', sans-serif;
      font-size: 0.97rem;
      font-weight: 400;
      outline: none;
      appearance: none;
      transition: border-color 0.18s, box-shadow 0.18s;
    }

    input.invalid, select.invalid { border-color: var(--error) !important; box-shadow: 0 0 0 3px rgba(248,113,113,0.13) !important; }
    input:focus, select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(91,127,255,0.13);
    }

    input::placeholder { color: #3a3e50; }
    select option { background: #18191f; }

    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
    .row-address { display: grid; grid-template-columns: 1fr 140px; gap: 1rem; }

    /* ‚îÄ‚îÄ Stripe card element ‚îÄ‚îÄ */
    #card-element {
      background: var(--input-bg);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 1rem 1.1rem;
      transition: border-color 0.18s, box-shadow 0.18s;
    }
    #card-element.focused {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(91,127,255,0.13);
    }
    #card-errors {
      color: var(--error);
      font-size: 0.8rem;
      margin-top: 0.5rem;
      min-height: 1.1em;
    }

    /* ‚îÄ‚îÄ Info box ‚îÄ‚îÄ */
    .info-box {
      background: var(--info-bg);
      border: 1px solid var(--info-border);
      border-radius: 10px;
      padding: 0.9rem 1rem;
      font-size: 0.85rem;
      color: var(--info-text);
      margin-bottom: 1.2rem;
      display: flex;
      gap: 0.7rem;
      align-items: flex-start;
      line-height: 1.55;
    }
    .info-box .i-icon {
      background: var(--accent);
      color: #fff;
      border-radius: 50%;
      width: 18px; height: 18px;
      min-width: 18px;
      display: flex; align-items: center; justify-content: center;
      font-size: 0.7rem; font-weight: 700; margin-top: 1px;
    }

    /* ‚îÄ‚îÄ Coupon ‚îÄ‚îÄ */
    .coupon-row { display: flex; gap: 0.7rem; }
    .coupon-row input { flex: 1; }
    .coupon-btn {
      background: #22242e;
      border: 1px solid var(--border);
      border-radius: 10px;
      color: var(--text);
      font-family: 'Inter', sans-serif;
      font-size: 0.85rem;
      font-weight: 600;
      padding: 0 1.2rem;
      cursor: pointer;
      white-space: nowrap;
      transition: border-color 0.18s, background 0.18s;
    }
    .coupon-btn:hover { border-color: var(--accent); background: #1e2030; }
    .coupon-status { font-size: 0.8rem; margin-top: 0.4rem; min-height: 1.1em; }
    .coupon-status.ok { color: var(--success); }
    .coupon-status.err { color: var(--error); }

    /* ‚îÄ‚îÄ Custom checkboxes ‚îÄ‚îÄ */
    .check-group {
      display: flex;
      gap: 0.8rem;
      align-items: flex-start;
      margin-bottom: 1rem;
    }
    .check-group input[type="checkbox"] { display: none; }
    .check-box {
      width: 20px; height: 20px; min-width: 20px;
      border: 2px solid #3a3e52;
      border-radius: 5px;
      background: var(--input-bg);
      cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      transition: background 0.15s, border-color 0.15s;
      margin-top: 1px;
    }
    .check-group input[type="checkbox"]:checked ~ .check-label .check-box,
    .check-group.checked .check-box {
      background: var(--accent);
      border-color: var(--accent);
    }
    .check-group input[type="checkbox"]:checked ~ .check-label .check-box::after,
    .check-group.checked .check-box::after {
      content: '‚úì';
      color: #fff;
      font-size: 12px;
      font-weight: 700;
      line-height: 1;
    }
    .check-group.error .check-box { border-color: var(--error); }

    .check-label {
      display: flex;
      gap: 0.8rem;
      align-items: flex-start;
      cursor: pointer;
      font-size: 0.83rem;
      color: var(--muted);
      line-height: 1.6;
    }
    .check-label span { flex: 1; }
    .check-label a { color: var(--accent); text-decoration: none; }
    .check-label a:hover { text-decoration: underline; }

    /* ‚îÄ‚îÄ Submit button ‚îÄ‚îÄ */
    .submit-btn {
      width: 100%;
      background: var(--accent);
      color: #fff;
      border: none;
      border-radius: 12px;
      padding: 1.1rem;
      font-family: 'Inter', sans-serif;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.18s, transform 0.15s;
      margin-top: 0.3rem;
      margin-bottom: 1.2rem;
      letter-spacing: 0.01em;
    }
    .submit-btn:hover:not(:disabled) { background: var(--accent-hover); transform: translateY(-1px); }
    .submit-btn:disabled { opacity: 0.45; cursor: not-allowed; transform: none; }
    .spinner {
      display: none;
      width: 18px; height: 18px;
      border: 2px solid rgba(255,255,255,0.3);
      border-top-color: #fff;
      border-radius: 50%;
      animation: spin 0.7s linear infinite;
      margin: 0 auto;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* ‚îÄ‚îÄ Legal footer ‚îÄ‚îÄ */
    .legal {
      text-align: center;
      font-size: 0.78rem;
      color: var(--muted);
      line-height: 1.8;
    }
    .legal a { color: var(--muted); text-decoration: underline; text-underline-offset: 2px; }
    .legal a:hover { color: var(--text); }
    .sep { margin: 0 0.35rem; opacity: 0.35; }

    .powered {
      display: flex; align-items: center; justify-content: center;
      gap: 0.4rem; margin-top: 1rem;
      font-size: 0.74rem; color: #3a3e52;
    }
    .powered svg { height: 15px; fill: #3a3e52; }

    /* ‚îÄ‚îÄ Success ‚îÄ‚îÄ */
    .success-screen {
      display: none;
      text-align: center;
      padding: 3rem 2rem;
    }
    .success-icon {
      width: 72px; height: 72px;
      background: rgba(52,211,153,0.1);
      border: 2px solid var(--success);
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-size: 2rem; margin: 0 auto 1.5rem;
    }
    .success-screen h2 {
      font-family: 'Playfair Display', serif;
      font-size: 2rem; margin-bottom: 0.8rem;
    }
    .success-screen p { color: var(--muted); font-size: 0.93rem; line-height: 1.7; }
    .billing-info {
      background: #15191f;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1.1rem 1.3rem;
      margin-top: 1.5rem;
      font-size: 0.87rem;
      line-height: 1.7;
      text-align: left;
    }
    .billing-info strong { color: var(--success); }

    @media (max-width: 500px) {
      .row { grid-template-columns: 1fr; }
      .row-address { grid-template-columns: 1fr; }
      h1 { font-size: 2.1rem; }
      .card { padding: 1.5rem 1.2rem; }
    }
  </style>
</head>
<body>

<!-- ‚îÄ‚îÄ Header ‚îÄ‚îÄ -->
<div class="header">
  <div class="pill">üîí S√§ker betalning via Stripe</div>
  <h1>V√§lj ditt paket</h1>
  <p class="subtitle">Fakturering sker den 28:e varje m√•nad. Inget att betala idag.</p>
</div>

<!-- ‚îÄ‚îÄ Form ‚îÄ‚îÄ -->
<div id="checkout-form">
  <div class="card">

    <!-- Kontaktinfo -->
    <p class="section-label">Dina uppgifter</p>

    <div class="form-group">
      <label class="field-label" for="name">Namn <span style="color:var(--error)">*</span></label>
      <input type="text" id="name" placeholder="Anna Andersson" autocomplete="name"/>
    </div>

    <div class="form-group">
      <label class="field-label" for="email">E-postadress <span style="color:var(--error)">*</span></label>
      <input type="email" id="email" placeholder="anna@foretag.se" autocomplete="email"/>
    </div>

    <div class="form-group">
      <label class="field-label" for="company">F√∂retagsnamn <span style="color:var(--error)">*</span></label>
      <input type="text" id="company" placeholder="F√∂retaget AB" autocomplete="organization"/>
    </div>

    <!-- F√∂retagsadress + Postnr p√• samma rad -->
    <div class="row-address">
      <div class="form-group">
        <label class="field-label" for="address">F√∂retagsadress <span style="color:var(--error)">*</span></label>
        <input type="text" id="address" placeholder="Storgatan 1, Stockholm" autocomplete="street-address"/>
      </div>
      <div class="form-group">
        <label class="field-label" for="postalCode">Postnr <span style="color:var(--error)">*</span></label>
        <input type="text" id="postalCode" placeholder="111 22" autocomplete="postal-code"/>
      </div>
    </div>

    <div class="row">
      <div class="form-group">
        <label class="field-label" for="phone">Telefonnummer <span style="color:var(--error)">*</span></label>
        <input type="tel" id="phone" placeholder="070-123 45 67" autocomplete="tel"/>
      </div>
      <div class="form-group">
        <label class="field-label" for="country">Land/region <span style="color:var(--error)">*</span></label>
        <select id="country">
          <option value="SE" selected>üá∏üá™ Sverige</option>
          <option value="NO">üá≥üá¥ Norge</option>
          <option value="DK">üá©üá∞ Danmark</option>
          <option value="FI">üá´üáÆ Finland</option>
          <option value="DE">üá©üá™ Tyskland</option>
          <option value="GB">üá¨üáß Storbritannien</option>
          <option value="US">üá∫üá∏ USA</option>
          <option value="OTHER">Annat</option>
        </select>
      </div>
    </div>

    <hr class="divider"/>

    <!-- Paket -->
    <p class="section-label">Paket &amp; antal anv√§ndare</p>

    <div class="form-group">
      <label class="field-label" for="currency">Valuta <span style="color:var(--error)">*</span></label>
      <select id="currency" onchange="updatePrice()">
        <option value="SEK" selected>üá∏üá™ SEK ‚Äî Svenska kronor</option>
        <option value="EUR">üá™üá∫ EUR ‚Äî Euro</option>
      </select>
    </div>

    <div class="row">
      <div class="form-group">
        <label class="field-label" for="product">Paket <span style="color:var(--error)">*</span></label>
        <select id="product" onchange="updatePrice()">
          <option value="">V√§lj paket...</option>
          <option value="premiumE5">Premium Paket E5</option>
          <option value="premiumE3">Premium Paket E3</option>
          <option value="secCloud">Sec-Cloud Paket</option>
          <option value="ekonomiExtended">EKONOMI Paket Extended</option>
          <option value="basExtended">Bas Paket Extended</option>
        </select>
      </div>
      <div class="form-group">
        <label class="field-label" for="quantity">Antal anv√§ndare <span style="color:var(--error)">*</span></label>
        <input type="number" id="quantity" min="1" placeholder="1" oninput="updatePrice()"/>
      </div>
    </div>

    <!-- Price summary box -->
    <div id="price-box" style="display:none; background:#0e1420; border:1px solid #2a3560; border-radius:12px; padding:1.1rem 1.3rem; margin-bottom:0.5rem;">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:0.6rem;">
        <span id="label-per-user" style="font-size:0.82rem; color:#7a7f91; letter-spacing:0.05em; text-transform:uppercase;"></span>
        <span id="price-per-user" style="font-size:0.95rem; color:#e0e4f0; font-weight:500;"></span>
      </div>
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:0.6rem;">
        <span id="label-subtotal" style="font-size:0.82rem; color:#7a7f91; letter-spacing:0.05em; text-transform:uppercase;"></span>
        <span id="price-subtotal" style="font-size:0.95rem; color:#e0e4f0; font-weight:500;"></span>
      </div>
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:0.6rem;">
        <span id="label-vat" style="font-size:0.82rem; color:#7a7f91; letter-spacing:0.05em; text-transform:uppercase;"></span>
        <span id="price-vat" style="font-size:0.95rem; color:#e0e4f0; font-weight:500;"></span>
      </div>
      <div id="discount-row" style="display:none; justify-content:space-between; align-items:center; margin-bottom:0.6rem;">
        <span style="font-size:0.82rem; color:#34d399; letter-spacing:0.05em; text-transform:uppercase;" id="label-discount"></span>
        <span id="price-discount" style="font-size:0.95rem; color:#34d399; font-weight:600;"></span>
      </div>
      <div style="display:flex; justify-content:space-between; align-items:center; border-top:1px solid #1e2540; padding-top:0.7rem; margin-top:0.2rem;">
        <span id="label-total" style="font-size:0.82rem; color:#7a7f91; letter-spacing:0.05em; text-transform:uppercase;"></span>
        <span id="price-total" style="font-size:1.15rem; color:#f0f1f5; font-weight:700;"></span>
      </div>
      <div id="label-no-charge" style="margin-top:0.6rem; font-size:0.75rem; color:#5b6a8a;"></div>
    </div>

    <hr class="divider"/>

    <!-- Kortuppgifter -->
    <p class="section-label">Kortuppgifter</p>

    <div class="info-box">
      <div class="i-icon">i</div>
      <span>Ditt kort sparas men <strong>inget debiteras idag</strong>. F√∂rsta faktura skickas den 28:e n√§sta m√•nad och d√§refter den 28:e varje m√•nad.</span>
    </div>

    <div class="form-group">
      <label class="field-label">Kortnummer <span style="color:var(--error)">*</span></label>
      <div id="card-element"></div>
      <div id="card-errors"></div>
    </div>

    <div class="form-group">
      <label class="field-label" for="cardholder">Kortinnehavarens namn <span style="color:var(--error)">*</span></label>
      <input type="text" id="cardholder" placeholder="Anna Andersson" autocomplete="cc-name"/>
    </div>

    <hr class="divider"/>

    <!-- Kampanjkod -->
    <p class="section-label">Kampanjkod</p>
    <div class="form-group">
      <div class="coupon-row">
        <input type="text" id="coupon" placeholder="Ange kampanjkod"/>
        <button type="button" class="coupon-btn" onclick="applyCoupon()">L√§gg till</button>
      </div>
      <div class="coupon-status" id="coupon-status"></div>
    </div>

    <hr class="divider"/>

    <!-- Villkor -->
    <div class="check-group" id="group-terms" onclick="toggleCheck('terms', 'group-terms')">
      <input type="checkbox" id="terms"/>
      <label class="check-label" for="terms">
        <div class="check-box"></div>
        <span>Jag godk√§nner <a href="https://inexpro.net/allmanna-villkor/" target="_blank" onclick="event.stopPropagation()">Tj√§nstevillkoren</a> och <a href="https://inexpro.net/Integritetspolicy/" target="_blank" onclick="event.stopPropagation()">Integritetspolicyn</a> f√∂r InexPro. <span style="color:var(--error)">*</span></span>
      </label>
    </div>

    <div class="check-group" id="group-recurring" onclick="toggleCheck('recurring', 'group-recurring')">
      <input type="checkbox" id="recurring"/>
      <label class="check-label" for="recurring">
        <div class="check-box"></div>
        <span>Genom att prenumerera godk√§nner jag att InexPro debiterar mig enligt villkoren tills jag avbryter. Jag √§r <a href="https://inexpro.net/policy-retur/" target="_blank" onclick="event.stopPropagation()">ber√§ttigad till en √•terbetalning</a> enligt √•terbetalningspolicyn. <span style="color:var(--error)">*</span></span>
      </label>
    </div>

    <button type="button" class="submit-btn" id="submit-btn" onclick="handleSubmit()">
      <span id="btn-text">Aktivera tj√§nstepaket</span>
      <div class="spinner" id="spinner"></div>
    </button>
    <div style="text-align:center; margin-top:0.75rem; margin-bottom:0.25rem;">
      <span style="font-size:0.78rem; color:#6b7280; letter-spacing:0.03em;">Summa att betala idag</span>
      <span style="font-size:1rem; font-weight:700; color:#34d399; margin-left:0.5rem;">0,00 kr</span>
      <span style="font-size:0.75rem; color:#4b5563; margin-left:0.4rem;">‚Äî Faktura skickas den 28:e n√§sta m√•nad</span>
    </div>

    <!-- Legal footer -->
    <div class="legal">
      <div>Genom att prenumerera godk√§nner du att InexPro debiterar dig enligt villkoren tills du avbryter.</div>
      <div style="margin-top:0.3rem">
        <a href="https://inexpro.net/allmanna-villkor/" target="_blank">Juridisk information</a>
        <span class="sep">|</span>
        <a href="https://inexpro.net/policy-retur/" target="_blank">√Öterbetalningar</a>
        <span class="sep">|</span>
        <a href="https://inexpro.net/Integritetspolicy/" target="_blank">Integritetspolicy</a>
      </div>
      <div style="margin-top:0.3rem">
        Kontakta support: <a href="mailto:info@inexpro.net">info@inexpro.net</a>
        eller <a href="https://inexpro.net" target="_blank">inexpro.net</a>
      </div>
      <div class="powered">
        <span>Powered by</span>
        <svg viewBox="0 0 60 25" xmlns="http://www.w3.org/2000/svg"><path d="M59.64 14.28h-8.06c.19 1.93 1.6 2.55 3.2 2.55 1.64 0 2.96-.37 4.05-.95v3.32a8.33 8.33 0 01-4.56 1.1c-4.01 0-6.83-2.5-6.83-7.48 0-4.19 2.39-7.52 6.3-7.52 3.92 0 5.96 3.28 5.96 7.5 0 .4-.04 1.26-.06 1.48zm-5.92-5.62c-1.03 0-2.17.73-2.17 2.58h4.25c0-1.85-1.07-2.58-2.08-2.58zM40.95 20.3c-1.44 0-2.32-.6-2.9-1.04l-.02 4.63-4.12.87V6.27h3.64l.18 1.02c.56-.69 1.58-1.29 3.06-1.29 2.9 0 5.62 2.6 5.62 7.06 0 5-2.7 7.24-5.46 7.24zM40 9.97c-.56 0-1.33.24-1.72.69l.03 5.45c.37.43 1.14.69 1.69.69 1.29 0 2.22-1.44 2.22-3.42 0-1.93-.94-3.41-2.22-3.41zM28.24 5.06L24.1 5.97V2.18l4.14-.87zM24.1 6.27h4.14V20h-4.14zM20.54 7.29c-.64-.24-1.67-.48-2.9-.48-2.44 0-3.54 1.28-3.54 2.54 0 1.44.94 2.23 3.15 3.13 2.85 1.14 4.17 2.7 4.17 5.17 0 3.1-2.4 5.35-6.6 5.35a11.28 11.28 0 01-4.56-.96v-3.93c1.36.75 2.86 1.3 4.56 1.3 1.42 0 2.4-.56 2.4-1.67 0-1.04-.75-1.74-2.84-2.6-2.75-1.1-4.4-2.6-4.4-5.15 0-2.88 2.3-5.12 6.47-5.12 1.61 0 3.1.34 4.1.74l-.01 3.68zM5.18 20.35c-2.22 0-3.6-.86-4.5-1.48L0 22.06c1.06.7 2.86 1.55 5.18 1.55 4.05 0 6.48-2.28 6.48-5.9 0-2.62-1.44-4.3-4.32-5.34-1.86-.68-2.5-1.1-2.5-1.98 0-.76.62-1.3 1.8-1.3 1.3 0 2.56.52 3.42 1.02l.6-3.47C9.56 6.1 8.1 5.7 6.3 5.7 2.6 5.7 0 7.9 0 11.36c0 2.6 1.6 4.3 4.5 5.36 1.8.66 2.4 1.1 2.4 2.02 0 .9-.72 1.61-1.72 1.61z"/></svg>
      </div>
    </div>

  </div>
</div>

<!-- ‚îÄ‚îÄ Success ‚îÄ‚îÄ -->
<div class="card success-screen" id="success-screen">
  <div class="success-icon">‚úì</div>
  <h2>Prenumeration aktiverad!</h2>
  <p>Tack! Din prenumeration √§r nu aktiv.<br>Inget har debiterats idag.</p>
  <div class="billing-info">
    F√∂rsta faktura skickas <strong id="billing-date"></strong> och d√§refter den <strong>28:e varje m√•nad</strong>.
    <br><br>
    En bekr√§ftelse skickas till <strong id="confirm-email"></strong>.
  </div>
  <br>
  <div class="legal">
    <a href="https://inexpro.net/policy-retur/" target="_blank">√Öterbetalningspolicy</a>
    <span class="sep">|</span>
    <a href="mailto:info@inexpro.net">info@inexpro.net</a>
  </div>
</div>

<script>
  const STRIPE_PUBLISHABLE_KEY = 'pk_live_yf7boCDIeKmOAQunP4K5FWIC';

  const stripe = Stripe(STRIPE_PUBLISHABLE_KEY);
  const elements = stripe.elements();
  const cardElement = elements.create('card', {
    style: {
      base: {
        color: '#f0f1f5',
        fontFamily: 'Inter, sans-serif',
        fontSize: '15px',
        fontSmoothing: 'antialiased',
        '::placeholder': { color: '#3a3e50' },
      },
      invalid: { color: '#f87171' },
    },
  });
  cardElement.mount('#card-element');
  cardElement.on('focus', () => document.getElementById('card-element').classList.add('focused'));
  cardElement.on('blur',  () => document.getElementById('card-element').classList.remove('focused'));
  cardElement.on('change', e => { document.getElementById('card-errors').textContent = e.error ? e.error.message : ''; });

  document.querySelectorAll('input, select').forEach(el => {
    el.addEventListener('input', () => el.classList.remove('invalid'));
    el.addEventListener('change', () => el.classList.remove('invalid'));
  });

  function toggleCheck(id, groupId) {
    const cb = document.getElementById(id);
    cb.checked = !cb.checked;
    const group = document.getElementById(groupId);
    group.classList.toggle('checked', cb.checked);
    group.classList.remove('error');
  }

  let validCouponId = null;
  let validCouponData = null;
  async function applyCoupon() {
    const code = document.getElementById('coupon').value.trim();
    const statusEl = document.getElementById('coupon-status');
    if (!code) return;
    statusEl.textContent = 'Kontrollerar...';
    statusEl.className = 'coupon-status';
    try {
      const res = await fetch('/api/check-coupon', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ code }) });
      const data = await res.json();
      if (data.valid) {
        validCouponId = data.couponId;
        validCouponData = { ...data, percentOff: data.percentOff, amountOff: data.amountOff };
        statusEl.textContent = '‚úì Kampanjkod tillagd: ' + data.description;
        statusEl.className = 'coupon-status ok';
        updatePrice();
      } else {
        validCouponId = null;
        validCouponData = null;
        statusEl.textContent = 'Ogiltig kampanjkod.';
        statusEl.className = 'coupon-status err';
        updatePrice();
      }
    } catch { statusEl.textContent = 'Kunde inte kontrollera koden.'; statusEl.className = 'coupon-status err'; }
  }

  async function handleSubmit() {
    const name       = document.getElementById('name').value.trim();
    const email      = document.getElementById('email').value.trim();
    const company    = document.getElementById('company').value.trim();
    const address    = document.getElementById('address').value.trim();
    const postalCode = document.getElementById('postalCode').value.trim(); // ‚Üê NY
    const phone      = document.getElementById('phone').value.trim();
    const country    = document.getElementById('country').value;
    const currency   = document.getElementById('currency').value;
    const product    = document.getElementById('product').value;
    const quantity   = document.getElementById('quantity').value;
    const cardholder = document.getElementById('cardholder').value.trim();
    const terms      = document.getElementById('terms').checked;
    const recurring  = document.getElementById('recurring').checked;
    const errEl      = document.getElementById('card-errors');

    const fields = [
      { id: 'name',       val: name },
      { id: 'email',      val: email },
      { id: 'company',    val: company },
      { id: 'address',    val: address },
      { id: 'postalCode', val: postalCode }, // ‚Üê NY
      { id: 'phone',      val: phone },
      { id: 'product',    val: product },
      { id: 'quantity',   val: quantity },
      { id: 'cardholder', val: cardholder },
    ];
    let hasEmpty = false;
    fields.forEach(f => {
      const el = document.getElementById(f.id);
      if (!f.val) { el.classList.add('invalid'); hasEmpty = true; }
      else el.classList.remove('invalid');
    });
    if (hasEmpty) {
      errEl.textContent = 'V√§nligen fyll i alla obligatoriska f√§lt.';
      return;
    }

    document.getElementById('group-terms').classList.toggle('error', !terms);
    document.getElementById('group-recurring').classList.toggle('error', !recurring);
    if (!terms || !recurring) {
      errEl.textContent = 'Du m√•ste godk√§nna villkoren f√∂r att forts√§tta.';
      return;
    }

    setLoading(true);
    errEl.textContent = '';

    const { paymentMethod, error } = await stripe.createPaymentMethod({
      type: 'card', card: cardElement,
      billing_details: { name: cardholder || name, email, phone },
    });

    if (error) { errEl.textContent = error.message; setLoading(false); return; }

    try {
      const res = await fetch('/api/subscribe', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          name, email, company, address, postalCode, // ‚Üê postalCode tillagt
          phone, country, currency,
          paymentMethodId: paymentMethod.id,
          productKey: product,
          quantity: parseInt(quantity),
          couponId: validCouponId || null,
        }),
      });
      const data = await res.json();
      if (data.success) {
        document.getElementById('billing-date').textContent = data.firstBillingDate;
        document.getElementById('confirm-email').textContent = email;
        document.getElementById('checkout-form').style.display = 'none';
        document.getElementById('success-screen').style.display = 'block';
        window.scrollTo({ top: 0, behavior: 'smooth' });
      } else {
        errEl.textContent = data.error || 'N√•got gick fel. F√∂rs√∂k igen.';
        setLoading(false);
      }
    } catch { errEl.textContent = 'Serverfel. Kontakta info@inexpro.net'; setLoading(false); }
  }

  const PRICES_SEK = {
    premiumE5:       6499,
    premiumE3:       4499,
    secCloud:        2899,
    ekonomiExtended: 2299,
    basExtended:     1799,
    testProd1:       null,
  };

  let eurRate = null;

  async function fetchEurRate() {
    if (eurRate) return eurRate;
    try {
      const res = await fetch('https://api.frankfurter.app/latest?from=SEK&to=EUR');
      const data = await res.json();
      eurRate = data.rates.EUR;
    } catch {
      eurRate = 0.089;
    }
    return eurRate;
  }

  async function updatePrice() {
    const productKey = document.getElementById('product').value;
    const quantity   = parseInt(document.getElementById('quantity').value) || 0;
    const currency   = document.getElementById('currency').value;
    const box        = document.getElementById('price-box');
    const isEUR      = currency === 'EUR';

    const labels = isEUR ? {
      perUser:    'Price per user (excl. VAT)',
      subtotal:   'Subtotal (excl. VAT)',
      vat:        'VAT (25 %)',
      total:      'Total per month (incl. VAT)',
      discount:   'Discount',
      noCharge:   '‚úì Nothing charged today ‚Äî first invoice on the 28th next month',
    } : {
      perUser:    'Pris per anv√§ndare (exkl. moms)',
      subtotal:   'Delsumma (exkl. moms)',
      vat:        'Moms (25 %)',
      total:      'Totalt per m√•nad (inkl. moms)',
      discount:   'Rabatt',
      noCharge:   '‚úì Inget debiteras idag ‚Äî f√∂rsta faktura den 28:e n√§sta m√•nad',
    };

    document.getElementById('label-per-user').textContent  = labels.perUser;
    document.getElementById('label-subtotal').textContent  = labels.subtotal;
    document.getElementById('label-vat').textContent       = labels.vat;
    document.getElementById('label-total').textContent     = labels.total;
    document.getElementById('label-no-charge').textContent = labels.noCharge;

    const priceSEK = PRICES_SEK[productKey];
    if (!productKey || priceSEK === undefined || priceSEK === null || quantity < 1) {
      box.style.display = 'none';
      return;
    }

    const VAT = 0.25;
    let pricePerUser;

    if (isEUR) {
      const rate = await fetchEurRate();
      const perUser = priceSEK * rate;
      const sub = perUser * quantity;
      const discountEur = validCouponData?.percentOff ? sub * (validCouponData.percentOff / 100) : (validCouponData?.amountOff || 0) * rate;
      const discountedSub = Math.max(0, sub - discountEur);
      const v = discountedSub * VAT;
      const fmt = n => n.toLocaleString('sv-SE', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' ‚Ç¨';
      pricePerUser = fmt(perUser);
      document.getElementById('price-per-user').textContent  = pricePerUser;
      document.getElementById('price-subtotal').textContent  = fmt(sub) + '/month';
      document.getElementById('price-vat').textContent       = fmt(v) + '/month';
      document.getElementById('price-total').textContent     = fmt(discountedSub + v) + '/month';
      if (validCouponData && discountEur > 0) {
        document.getElementById('label-discount').textContent  = labels.discount + ' (' + (validCouponData.description || '') + ')';
        document.getElementById('price-discount').textContent  = '-' + fmt(discountEur) + '/month';
        document.getElementById('discount-row').style.display = 'flex';
      } else {
        document.getElementById('discount-row').style.display = 'none';
      }
    } else {
      const sub = priceSEK * quantity;
      const discountSEK = validCouponData?.percentOff ? sub * (validCouponData.percentOff / 100) : (validCouponData?.amountOff || 0);
      const discountedSub = Math.max(0, sub - discountSEK);
      const v = discountedSub * VAT;
      const fmt = n => n.toLocaleString('sv-SE', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' kr';
      pricePerUser = fmt(priceSEK);
      document.getElementById('price-per-user').textContent  = pricePerUser;
      document.getElementById('price-subtotal').textContent  = fmt(sub) + '/m√•n';
      document.getElementById('price-vat').textContent       = fmt(v) + '/m√•n';
      document.getElementById('price-total').textContent     = fmt(discountedSub + v) + '/m√•n';
      if (validCouponData && discountSEK > 0) {
        document.getElementById('label-discount').textContent  = labels.discount + ' (' + (validCouponData.description || '') + ')';
        document.getElementById('price-discount').textContent  = '-' + fmt(discountSEK) + '/m√•n';
        document.getElementById('discount-row').style.display = 'flex';
      } else {
        document.getElementById('discount-row').style.display = 'none';
      }
    }

    box.style.display = 'block';
  }

  function setLoading(on) {
    document.getElementById('submit-btn').disabled = on;
    document.getElementById('btn-text').style.display = on ? 'none' : 'block';
    document.getElementById('spinner').style.display = on ? 'block' : 'none';
  }
</script>
</body>
</html>
